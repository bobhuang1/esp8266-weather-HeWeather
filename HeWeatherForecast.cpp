#include <ESP8266WiFi.h>
#include <WiFiClientSecure.h>
#include "HeWeatherForecast.h"

HeWeatherForecast::HeWeatherForecast() {

}

uint8_t HeWeatherForecast::updateForecast(HeWeatherForecastData *data, String appId, String location, String language) {
	return doUpdate(data, "/s6/weather/forecast?location=" + location + "&key=" + appId + "&lang=" + language);
	// https://free-api.heweather.com/s6/weather/forecast?location=CN101210202&key=d72b42bcfc994cfe9099eddc9647c6f2&lang=zh
}

uint8_t HeWeatherForecast::doUpdate(HeWeatherForecastData *data, String url) {
	Serial.println("doUpdate");
	Serial.println(url);
	if (WiFi.status() != WL_CONNECTED) return 0;
	JsonStreamingParser parser;
	parser.setListener(this);
	WiFiClientSecure client;
	client.setFingerprint("07d3c71441672357ef98fbfe9a67f22940377103");
	unsigned long lostTest = 30000UL;
	unsigned long lost_do = millis();
	this->data = data;
	this->currentForecast = 0;

	const char host[] = "free-api.heweather.com";
	Serial.println(host);

	const int httpsPort = 443;
	if (!client.connect(host, httpsPort)) {
		Serial.println("connection failed");
		this->data = nullptr;
		return 0;
	}

	Serial.print("Requesting Host: ");
	Serial.println(host);
	Serial.print("Requesting URL: ");
	Serial.println(url);

	client.print(String("GET ") + url + " HTTP/1.1\r\n" +
		"Host: " + host + "\r\n" +
		"User-Agent: IBEDevices-ESP8266\r\n" +
		"Connection: close\r\n\r\n");

	Serial.println("request sent");

	int retryCounter = 0;
	while (!client.available()) {
		Serial.println(".");
		delay(1000);
		retryCounter++;
		if (retryCounter > 10) {
			this->data = nullptr;
			return 0;
		}
	}

	int pos = 0;
	boolean isBody = false;
	char c;

	int size = 0;
	client.setNoDelay(false);
	while (client.connected()) {
		while ((size = client.available()) > 0) {
			if ((millis() - lost_do) > lostTest) {
				Serial.println("lost in client with a timeout");
				client.stop();
				this->data = nullptr;
				return 0;
//				ESP.restart();
			}
			c = client.read();
			if (c == '{' || c == '[') {
				isBody = true;
			}
			if (isBody) {
				parser.parse(c);
			}
		}
	}
	this->data = nullptr;
	return currentForecast;
}


void HeWeatherForecast::whitespace(char c) {
	Serial.println("whitespace");
}

void HeWeatherForecast::startDocument() {
	Serial.println("start document");
}

void HeWeatherForecast::key(String key) {
	currentKey = String(key);
}

void HeWeatherForecast::value(String value) {
	int intMaxForecasts = 5;
	if (currentForecast < intMaxForecasts && currentKey == "cond_code_d") {
		data[currentForecast].cond_code_d = value.toInt();
		data[currentForecast].iconMeteoCon = getMeteoconIcon(value);
	}
	if (currentForecast < intMaxForecasts && currentKey == "cond_txt_d") {
		data[currentForecast].cond_txt_d = value;
	}
	if (currentForecast < intMaxForecasts && currentKey == "cond_txt_n") {
		data[currentForecast].cond_txt_n = value;
	}
	if (currentForecast < intMaxForecasts && currentKey == "date") {
		data[currentForecast].date = value;
	}
	if (currentForecast < intMaxForecasts && currentKey == "hum") {
		data[currentForecast].hum = value.toInt();
	}
	if (currentForecast < intMaxForecasts && currentKey == "pcpn") {
		data[currentForecast].pcpn = value.toFloat();
	}
	if (currentForecast < intMaxForecasts && currentKey == "pop") {
		data[currentForecast].pop = value.toInt();
	}
	if (currentForecast < intMaxForecasts && currentKey == "tmp_max") {
		data[currentForecast].tmp_max = value.toInt();
	}
	if (currentForecast < intMaxForecasts && currentKey == "tmp_min") {
		data[currentForecast].tmp_min = value.toInt();
	}
	if (currentForecast < intMaxForecasts && currentKey == "wind_dir") {
		data[currentForecast].wind_dir = value;
	}
	if (currentForecast < intMaxForecasts && currentKey == "wind_sc") {
		data[currentForecast].wind_sc = value;
	}
	if (currentForecast < intMaxForecasts && currentKey == "wind_spd") {
		data[currentForecast].wind_spd = value.toInt();
		currentForecast++;
	}
}

void HeWeatherForecast::endArray() {

}


void HeWeatherForecast::startObject() {
	currentParent = currentKey;
}

void HeWeatherForecast::endObject() {
}

void HeWeatherForecast::endDocument() {

}

void HeWeatherForecast::startArray() {

}


String HeWeatherForecast::getMeteoconIcon(String code) {
	if (code == "100") { return "B2"; }      //   Sunnyt           ;        Clear
	if (code == "101") { return "N5"; }      //5   Cloudy-day;        Cloudy-night. Code: 119
	if (code == "102") { return "HI"; }      //I   Partly cloudy-day;        Partly cloudy-night. Code: 116
	if (code == "103") { return "HI"; }      //I   Partly cloudy-day;        Partly cloudy-night. Code: 116
	if (code == "104") { return "Y%"; }      //%   Overcast-day;        Overcast-night. Code: 122
/*
200	ÓÐ·ç	Windy
201	Æ½¾²	Calm
202	Î¢·ç	Light Breeze
203	ºÍ·ç	Moderate/Gentle Breeze
204	Çå·ç	Fresh Breeze
205	Ç¿·ç/¾¢·ç	Strong Breeze
206	¼²·ç	High Wind, Near Gale
207	´ó·ç	Gale
208	ÁÒ·ç	Strong Gale
209	·ç±©	Storm
210	¿ñ±¬·ç	Violent Storm
211	ì«·ç	Hurricane
212	Áú¾í·ç	Tornado
213	ÈÈ´ø·ç±©	Tropical Storm
*/
	if (code == "200") { return "D9"; }
	if (code == "201") { return "D9"; }
	if (code == "202") { return "D9"; }
	if (code == "203") { return "D9"; }
	if (code == "204") { return "D9"; }
	if (code == "205") { return "EE"; }
	if (code == "206") { return "EE"; }
	if (code == "207") { return "FF"; }
	if (code == "208") { return "FF"; }
	if (code == "209") { return "FF"; }
	if (code == "210") { return "FF"; }
	if (code == "211") { return "FF"; }
	if (code == "212") { return "FF"; }
	if (code == "213") { return "FF"; }
/*
300	ÕóÓê	Shower Rain
301	Ç¿ÕóÓê	Heavy Shower Rain
302	À×ÕóÓê	Thundershower
303	Ç¿À×ÕóÓê	Heavy Thunderstorm
304	À×ÕóÓê°éÓÐ±ù±¢	Thundershower with hail
305	Ð¡Óê	Light Rain
306	ÖÐÓê	Moderate Rain
307	´óÓê	Heavy Rain
308	¼«¶Ë½µÓê	Extreme Rain
309	Ã«Ã«Óê/Ï¸Óê	Drizzle Rain
310	±©Óê	Storm
311	´ó±©Óê	Heavy Storm
312	ÌØ´ó±©Óê	Severe Storm
313	¶³Óê	Freezing Rain
314	Ð¡µ½ÖÐÓê	Light to moderate rain
315	ÖÐµ½´óÓê	Moderate to heavy rain
316	´óµ½±©Óê	Heavy rain to storm
317	±©Óêµ½´ó±©Óê	Storm to heavy storm
318	´ó±©Óêµ½ÌØ´ó±©Óê	Heavy to severe storm
399	Óê	Rain
*/
	if (code == "300") { return "Q7"; }      //7   Light rain shower-day;        Light rain shower-night. Code: 353
	if (code == "301") { return "R8"; }      //8   Moderate or heavy rain shower-day;        Moderate or heavy rain shower-night. Code: 356
	if (code == "302") { return "Z&"; }      //7   Torrential rain shower-day;        Torrential rain shower-night. Code: 359
	if (code == "303") { return "Z&"; }      //7   Torrential rain shower-day;        Torrential rain shower-night. Code: 359
	if (code == "304") { return "Z&"; }      //7   Torrential rain shower-day;        Torrential rain shower-night. Code: 359
	if (code == "305") { return "Q7"; }      //7   Light rain-day;        Light rain-night. Code: 296
	if (code == "306") { return "R8"; }      //8   Moderate rain-day;        Moderate rain-night. Code: 302
	if (code == "307") { return "X$"; }      //$   Heavy rain at times-day;        Heavy rain at times-night. Code: 305
	if (code == "308") { return "X$"; }      //$   Heavy rain-day;        Heavy rain-night. Code: 308
	if (code == "309") { return "Q7"; }      //7   Light rain shower-day;        Light rain shower-night. Code: 353
	if (code == "310") { return "X$"; }      //$   Heavy rain-day;        Heavy rain-night. Code: 308
	if (code == "311") { return "X$"; }      //$   Heavy rain-day;        Heavy rain-night. Code: 308
	if (code == "312") { return "X$"; }      //$   Heavy rain-day;        Heavy rain-night. Code: 308
	if (code == "313") { return "R8"; }      //8   Moderate or heavy freezing rain-day;        Moderate or heavy freezing rain-night. Code: 314
	if (code == "314") { return "Q7"; }      //7   Light rain-day;        Light rain-night. Code: 296
	if (code == "315") { return "R8"; }      //8   Moderate rain-day;        Moderate rain-night. Code: 302
	if (code == "316") { return "X$"; }      //$   Heavy rain at times-day;        Heavy rain at times-night. Code: 305
	if (code == "317") { return "X$"; }      //$   Heavy rain-day;        Heavy rain-night. Code: 308
	if (code == "318") { return "X$"; }      //$   Heavy rain-day;        Heavy rain-night. Code: 308
	if (code == "399") { return "X$"; }      //$   Heavy rain-day;        Heavy rain-night. Code: 308
/*
400	Ð¡Ñ©	Light Snow
401	ÖÐÑ©	Moderate Snow
402	´óÑ©	Heavy Snow
403	±©Ñ©	Snowstorm
404	Óê¼ÐÑ©	Sleet
405	ÓêÑ©ÌìÆø	Rain And Snow
406	ÕóÓê¼ÐÑ©	Shower Snow
407	ÕóÑ©	Snow Flurry
408	Ð¡µ½ÖÐÑ©	Light to moderate snow
409	ÖÐµ½´óÑ©	Moderate to heavy snow
410	´óµ½±©Ñ©	Heavy snow to snowstorm
499	Ñ©	Snow
*/
	if (code == "400") { return "U\""; }      //"   Light snow showers-day;        Light snow showers-night. Code: 368
	if (code == "401") { return "W#"; }      //#   Moderate snow-day;        Moderate snow-night. Code: 332
	if (code == "402") { return "W#"; }      //#   Heavy snow-day;        Heavy snow-night. Code: 338
	if (code == "403") { return "W#"; }      //#   Heavy snow-day;        Heavy snow-night. Code: 338
	if (code == "404") { return "U\""; }      //"   Light snow showers-day;        Light snow showers-night. Code: 368
	if (code == "405") { return "U\""; }      //"   Light snow showers-day;        Light snow showers-night. Code: 368
	if (code == "406") { return "U\""; }      //"   Light snow showers-day;        Light snow showers-night. Code: 368
	if (code == "407") { return "U\""; }      //"   Patchy snow possible-day;        Patchy snow possible-night. Code: 179
	if (code == "408") { return "W#"; }      //#   Heavy snow-day;        Heavy snow-night. Code: 338
	if (code == "409") { return "W#"; }      //#   Heavy snow-day;        Heavy snow-night. Code: 338
	if (code == "410") { return "W#"; }      //#   Heavy snow-day;        Heavy snow-night. Code: 338
	if (code == "499") { return "W#"; }      //#   Heavy snow-day;        Heavy snow-night. Code: 338
/*
500	±¡Îí	Mist
501	Îí	Foggy
502	ö²	Haze
503	ÑïÉ³	Sand
504	¸¡³¾	Dust
507	É³³¾±©	Duststorm
508	Ç¿É³³¾±©	Sandstorm
509	Å¨Îí	Dense fog
510	Ç¿Å¨Îí	Strong fog
511	ÖÐ¶Èö²	Moderate haze
512	ÖØ¶Èö²	Heavy haze
513	ÑÏÖØö²	Severe haze
514	´óÎí	Heavy fog
515	ÌØÇ¿Å¨Îí	Extra heavy fog
*/
	if (code == "500") { return "M9"; }      //9   Mist-day;        Mist-night. Code: 143
	if (code == "501") { return "JK"; }      //K   Fog-day;        Fog-night. Code: 248
	if (code == "502") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "503") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "504") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "505") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "506") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "507") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "508") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "509") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "510") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "511") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "512") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "513") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "514") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "515") { return "JK"; }      //K  Haze Fog-day;        Fog-night. Code: 248
/*
900	ÈÈ	Hot
901	Àä	Cold
999	Î´Öª	Unknown
*/
	if (code == "900") { return "''"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	if (code == "901") { return "''"; }      //K  Haze Fog-day;        Fog-night. Code: 248
	return "))";   // Nothing matched: N/A
}
